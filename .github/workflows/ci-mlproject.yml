name: CI - Train with MLflow Project (Advanced)

on:
  workflow_dispatch:   # bisa dijalankan manual
  push:
    paths:
      - "MLProject/**"
      - ".github/workflows/ci-mlproject.yml"

jobs:
  mlflow-ci:
    runs-on: ubuntu-latest

    steps:
      # 1. Set up job
      - name: Run actions/checkout@v4
        uses: actions/checkout@v4

      # 2. Set up Python
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # 3. Check Env
      - name: Check Env
        run: |
          echo "Working directory: $(pwd)"
          ls -R

      # 4. Install dependencies (untuk mlflow CLI)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mlflow==2.16.0 pyyaml

      # 5. Set MLflow Tracking URI (lokal -> ./mlruns)
      - name: Set MLflow Tracking URI
        run: |
          echo "MLFLOW_TRACKING_URI=file:$(pwd)/MLProject/mlruns" >> $GITHUB_ENV

      # 6. Run mlflow project (ini step utama retraining)
      - name: Run mlflow project
        working-directory: MLProject
        run: |
          # Pakai env-manager=local supaya mlflow pakai env Python yang sudah di-setup,
          # tidak mencoba conda "source activate" (yang bikin error di GitHub Actions)
          mlflow run . -e main --env-manager=local

      # 7. Get latest MLflow run_id (untuk build Docker)
      - name: Get latest MLflow run_id
        id: get_run
        working-directory: MLProject
        run: |
          python - << 'PY'
          import os
          from pathlib import Path
          import mlflow

          tracking_uri = "file:" + str((Path.cwd() / "mlruns").resolve())
          mlflow.set_tracking_uri(tracking_uri)

          client = mlflow.tracking.MlflowClient()
          exp = client.get_experiment_by_name("genre-game-mlproject")
          if exp is None:
              # fallback ke default experiment
              exp = client.get_experiment("0")

          runs = client.search_runs(
              [exp.experiment_id],
              order_by=["attributes.start_time DESC"],
              max_results=1,
          )
          run_id = runs[0].info.run_id
          print("Latest run_id:", run_id)

          out = os.environ["GITHUB_OUTPUT"]
          with open(out, "a") as f:
              f.write(f"run_id={run_id}\n")
          PY

      # 8. Install Python dependencies (opsional, untuk inference/test lokal, Skilled)
      - name: Install Python dependencies
        working-directory: MLProject
        run: |
          python - << 'PY'
          import yaml, subprocess
          env = yaml.safe_load(open("conda.yaml"))
          pkgs = [p for p in env.get("dependencies", []) if isinstance(p, dict) and "pip" in p]
          if pkgs:
              pip_pkgs = pkgs[0]["pip"]
              print("Installing:", pip_pkgs)
              subprocess.check_call(["pip", "install", *pip_pkgs])
          PY

      # 9. Upload artefak ke repositori (Skilled)
      - name: Upload MLflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mlflow_mlruns
          path: MLProject/mlruns

      # 9a. Archive MLflow mlruns jadi satu file zip
      - name: Archive MLflow mlruns
        run: |
          sudo apt-get update
          sudo apt-get install -y zip
          cd MLProject
          zip -r "mlruns_${GITHUB_RUN_ID}.zip" mlruns

      # 9b. Upload Artifacts TO Google Drive
      - name: Upload Artifacts TO Google Drive
        uses: Jumbo810/Upload_Github_Artifacts_TO_GDrive@v2.3.1
        with:
          # file yang baru kita zip barusan
          target: MLProject/mlruns_${{ github.run_id }}.zip
          # base64 dari JSON service account
          credentials: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
          # ID folder Google Drive tujuan
          parent_folder_id: ${{ secrets.GDRIVE_FOLDER_ID }}
          # opsional: auto replace file dengan nama sama
          override: true
          # opsional: taruh di subfolder per-branch
          child_folder: mlruns/${{ github.ref_name }}


      # 10. Generate Docker context from MLflow model (Opsi 1)
      - name: Generate MLflow Docker context
        working-directory: MLProject
        env:
          RUN_ID: ${{ steps.get_run.outputs.run_id }}
        run: |
          echo "Generate Dockerfile from MLflow model runs:/$RUN_ID/model"
          mlflow models generate-dockerfile \
            -m "runs:/$RUN_ID/model" \
            -d docker_ctx \
            --env-manager local

      # 11. Patch Dockerfile base image (ganti dari image default MLflow)
      - name: Patch Dockerfile base image
        working-directory: MLProject
        run: |
          echo "Before patch:"
          head -n 5 docker_ctx/Dockerfile || true

          # Ganti baris pertama menjadi base image Python resmi
          sed -i '1s|.*|FROM python:3.11-slim|' docker_ctx/Dockerfile

          # (opsional) hapus baris yang mengandung python3.8 kalau ada
          sed -i '/python3.8/d' docker_ctx/Dockerfile || true

          echo "After patch:"
          head -n 10 docker_ctx/Dockerfile || true

      # 12. Build Docker Image (Advanced)
      - name: Build Docker Image
        working-directory: MLProject
        env:
          IMAGE_BASE: ${{ secrets.DOCKERHUB_USERNAME }}/genre-game-model
        run: |
          IMAGE_NAME="$IMAGE_BASE:latest"
          echo "Building docker image: $IMAGE_NAME"
          docker build -t "$IMAGE_NAME" docker_ctx

      # 13. Log in to Docker Hub
      - name: Log in to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      # 14. Tag Docker Image (tambahkan tag pakai commit SHA, optional)
      - name: Tag Docker Image
        env:
          IMAGE_BASE: ${{ secrets.DOCKERHUB_USERNAME }}/genre-game-model
        run: |
          docker tag "$IMAGE_BASE:latest" "$IMAGE_BASE:${{ github.sha }}"

      # 15. Push Docker Image (Advanced)
      - name: Push Docker Image
        env:
          IMAGE_BASE: ${{ secrets.DOCKERHUB_USERNAME }}/genre-game-model
        run: |
          docker push "$IMAGE_BASE:latest"
          docker push "$IMAGE_BASE:${{ github.sha }}"
